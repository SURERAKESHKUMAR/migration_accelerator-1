@model ScanReportViewModel
@{
    ViewData["Title"] = "Secrets Scan Report";
    var findings = Model?.Findings?.Value;
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

<div class="container-fluid mt-4">

    <div class="card shadow-sm">

        <!-- HEADER -->
        <div class="card-header bg-primary text-white">
            <h5 class="mb-1">🔐 Secrets Scan Report</h5>
            <small>
                Repository: <strong>@Model?.RepoName</strong> |
                Scan Date: <strong>@Model?.ScanDate</strong>
            </small>
        </div>

        <div class="card-body">

            <!-- SEARCH -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <input id="searchInput"
                           class="form-control"
                           placeholder="Search by secret or file path..."
                           @(findings == null || findings.Count == 0 ? "disabled" : "") />
                </div>
            </div>

            <!-- DATA TABLE -->
            @if (findings != null && findings.Count > 0)
            {
                <div class="table-responsive">
                    <table id="secretsTable"
                           class="table table-bordered table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width:60px">#</th>
                                <th>Match</th>
                                <th>Secret</th>
                                <th>File</th>
                                <th class="text-center">Line Number</th>
                            </tr>
                        </thead>

                        <tbody>
                            @for (int i = 0; i < findings.Count; i++)
                            {
                                var f = findings[i];

                                string Mask(string s) =>
                                string.IsNullOrEmpty(s) || s.Length < 6
                                ? "******"
                                : s.Substring(0, 10) + "****" + s.Substring(s.Length - 3);

                                <tr>
                                    <td>@(i + 1)</td>

                                    <td class="text-muted fw-semibold">
                                        @Mask(f.Match)
                                    </td>

                                    <td class="text-muted fw-semibold">
                                        @Mask(f.Secret)
                                    </td>

                                    <td title="@f.File">
                                        @(f.File?.Length > 70
                                                                        ? "..." + f.File.Substring(f.File.Length - 70)
                                                                        : f.File)
                                    </td>

                                    <td class="text-center">@f.StartColumn</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <!-- NO DATA MESSAGE -->
                <div class="alert alert-info text-center p-4">
                    <h5 class="mb-2">✅ No Secrets Found</h5>
                    <p class="mb-0">
                        This repository does not contain any detectable secrets.
                    </p>
                </div>
            }

        </div>
    </div>
</div>

<script>
    // Search filter
    const search = document.getElementById("searchInput");
    if (search) {
        search.addEventListener("keyup", function () {
            const filter = this.value.toLowerCase();
            document.querySelectorAll("#secretsTable tbody tr")
                .forEach(row => {
                    row.style.display = row.innerText.toLowerCase().includes(filter)
                        ? ""
                        : "none";
                });
        });
    }
</script>
